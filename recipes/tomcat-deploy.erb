# Recipe: tomcat-deploy
# Deploy packaged tomcat server with included applications
 
# Application configuration
set :application, "<%= @app.name %>"
set :rails_env, "<%= @app_environment['name'] %>"

# Version control system (:git,:svn...) configuration
set :scm, "<%= @app['repository_type'] || ':git' %>"
set :repository, "<%= @app['repository_location'] %>"
set :branch, "<%= @app_environment['repository_branch'] || 'master' %>"

<% unless @app['repository_user'].blank? %>
set :scm_user, "<%= @app['repository_user'] %>"
<% end %>

<% unless @app['repository_password'].blank? %>
set :scm_password, "<%= @app['repository_password'] %>"
<% end %>

# Deploy transfer configuration (target path, user/password, ssh) 
set :deploy_to, "<%= @app_environment['deploy_path']  %>" 

<% unless @app_environment['deploy_user'].blank? %>
set :user, "<%= @app_environment['deploy_user'] %>"
<% end %> 

<% unless @app_environment['deploy_password'].blank? %>
set :password, "<%= @app_environment['deploy_password'] %>"
<% end %> 
set :deploy_via, "<%= @app_environment['deploy_via'] || 'remote_cache' %>"
set :copy_cache, "/tmp/cap-deploy-cache/#{application}"
set :copy_exclude, [".git", ".DS_Store", ".gitignore", ".gitmodules", ".svn", "**/.svn"]

set :use_sudo, false

# avoid asset warnings during deploys
set :normalize_asset_timestamps, false

# Run ssh-add and enable ssh agent forwarding
#`ssh-add`
# set :ssh_options, { :forward_agent => true }

# Retrieve servers linked to the application environment and prints them in Capistrano-readable format
<%= @app_environment.servers_cap_format('public_ip') %>

# Avoid shared directory links
set :shared_children, ["logs"]

# Setup installation directory if first deploy
after "deploy", "deploy:cleanup"