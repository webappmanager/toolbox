# Recipe to deploy Rails applications using Webappmanager

# Application configuration
set :application, "<%= @app.name %>"
set :rails_env, "<%= @app_environment['name'] %>"

# Version control system (:git,:svn...) configuration
set :scm, "<%= @app['repository_type'] || ':git' %>"
set :repository, "<%= @app['repository_location'] %>"
set :branch, "<%= @app_environment['repository_branch'] || 'master' %>"

<% unless @app['repository_user'].blank? %>
set :scm_user, "<%= @app['repository_user'] %>"
<% end %>

<% unless @app['repository_password'].blank? %>
set :scm_password, "<%= @app['repository_password'] %>"
<% end %>

# Deploy transfer configuration (target path, user/password, ssh) 
set :deploy_to, "<%= @app_environment['deploy_path']  %>" 

<% unless @app_environment['deploy_user'].blank? %>
set :user, "<%= @app_environment['deploy_user'] %>"
<% end %> 

<% unless @app_environment['deploy_password'].blank? %>
set :password, "<%= @app_environment['deploy_password'] %>"
<% end %> 
set :deploy_via, "<%= @app_environment['deploy_via'] || 'remote_cache' %>"
set :copy_cache, "/tmp/cap-deploy-cache/#{application}"
set :copy_exclude, [".git", ".DS_Store", ".gitignore", ".gitmodules", ".svn", "**/.svn"]

set :use_sudo, false

# avoid asset warnings during deploys
set :normalize_asset_timestamps, false

# Run ssh-add and enable ssh agent forwarding
#`ssh-add`
# set :ssh_options, { :forward_agent => true }

# Retrieve servers linked to the application environment and prints them in Capistrano-readable format
<%= @app_environment.servers_cap_format('public_ip') %>

namespace :deploy do
  desc "Link shared files and directories / Install gems"
  task :bundle_install do
    # Link release directories to shared directories
    dir_list = ["vendor/bundle", "db/store"]
    run dir_list.map{|d| "mkdir -p #{shared_path}/#{d} && ln -nfs #{shared_path}/#{d} #{release_path}/#{d}"}.join("; ")

    # replace built-in bundler call
    run "cd #{current_path} && bundle install --deployment"
  end
end

# Setup installation directory if first deploy
after "deploy:update", "deploy:bundle_install"
after "deploy", "deploy:migrate"
after "deploy", "deploy:cleanup"
